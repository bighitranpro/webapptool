name: Daily Database Backup

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  backup:
    name: Backup Database
    runs-on: ubuntu-latest
    
    steps:
    - name: Backup database from production
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        script: |
          # Create backup directory
          mkdir -p /opt/backups
          
          # Backup database with timestamp
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="/opt/backups/email_tool_${TIMESTAMP}.db"
          
          # Copy database
          cp /opt/bighi-tool-mmo/email_tool.db "$BACKUP_FILE"
          
          # Compress backup
          gzip "$BACKUP_FILE"
          
          # Remove backups older than 30 days
          find /opt/backups -name "email_tool_*.db.gz" -mtime +30 -delete
          
          echo "Backup completed: ${BACKUP_FILE}.gz"
          ls -lh /opt/backups/ | tail -5
    
    - name: Notify backup success
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'Database backup completed successfully'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: success()
    
    - name: Notify backup failure
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'Database backup failed!'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: failure()
