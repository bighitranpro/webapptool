<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Checker - SMTP & Facebook Validator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìß Email Checker</h1>
            <p class="subtitle">Ki·ªÉm tra SMTP Live/Die | Facebook Account | Country Prediction</p>
        </header>

        <!-- Control Panel -->
        <div class="panel">
            <h2>üéØ T·∫°o & Ki·ªÉm Tra Email</h2>
            
            <div class="form-group">
                <label for="emailCount">S·ªë l∆∞·ª£ng email:</label>
                <input type="number" id="emailCount" min="1" max="1000" value="10" />
            </div>

            <div class="form-group">
                <label for="mixRatio">T·ª∑ l·ªá email Vi·ªát Nam (%):</label>
                <input type="range" id="mixRatio" min="0" max="100" value="70" />
                <span id="mixRatioValue">70%</span>
            </div>

            <div class="button-group">
                <button id="generateBtn" class="btn btn-primary">üé≤ T·∫°o Email</button>
                <button id="checkBtn" class="btn btn-success" disabled>‚úÖ Ki·ªÉm Tra</button>
                <button id="exportBtn" class="btn btn-info" disabled>üíæ Xu·∫•t CSV</button>
            </div>
        </div>

        <!-- Progress Bar -->
        <div id="progressContainer" class="progress-container" style="display: none;">
            <div class="progress-bar">
                <div id="progressBar" class="progress-fill"></div>
            </div>
            <p id="progressText">ƒêang x·ª≠ l√Ω: 0 / 0</p>
        </div>

        <!-- Statistics Charts -->
        <div id="statsContainer" class="stats-container" style="display: none;">
            <div class="chart-wrapper">
                <canvas id="smtpChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <canvas id="facebookChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <canvas id="countryChart"></canvas>
            </div>
        </div>

        <!-- Results Table -->
        <div class="panel">
            <h2>üìä K·∫øt Qu·∫£</h2>
            <div id="resultsInfo" class="results-info"></div>
            <div class="table-wrapper">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Email</th>
                            <th>SMTP</th>
                            <th>Facebook</th>
                            <th>Qu·ªëc Gia</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <tr>
                            <td colspan="6" class="no-data">Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y t·∫°o v√† ki·ªÉm tra email.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <p>¬© 2024 Email Checker | Made with ‚ù§Ô∏è for VPS Ubuntu</p>
        </footer>
    </div>

    <script>
        // Global variables
        let generatedEmails = [];
        let checkResults = [];
        let checkingInterval = null;
        let charts = { smtp: null, facebook: null, country: null };

        // DOM elements
        const emailCountInput = document.getElementById('emailCount');
        const mixRatioInput = document.getElementById('mixRatio');
        const mixRatioValue = document.getElementById('mixRatioValue');
        const generateBtn = document.getElementById('generateBtn');
        const checkBtn = document.getElementById('checkBtn');
        const exportBtn = document.getElementById('exportBtn');
        const resultsBody = document.getElementById('resultsBody');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const statsContainer = document.getElementById('statsContainer');
        const resultsInfo = document.getElementById('resultsInfo');

        // Update mix ratio display
        mixRatioInput.addEventListener('input', (e) => {
            mixRatioValue.textContent = `${e.target.value}%`;
        });

        // Generate emails
        generateBtn.addEventListener('click', async () => {
            const count = parseInt(emailCountInput.value);
            const mixRatio = parseInt(mixRatioInput.value) / 100;

            if (count < 1 || count > 1000) {
                alert('S·ªë l∆∞·ª£ng email ph·∫£i t·ª´ 1 ƒë·∫øn 1000');
                return;
            }

            generateBtn.disabled = true;
            generateBtn.textContent = '‚è≥ ƒêang t·∫°o...';

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count, mix_ratio: mixRatio })
                });

                const data = await response.json();

                if (data.success) {
                    generatedEmails = data.emails;
                    checkResults = [];
                    displayEmails(generatedEmails);
                    checkBtn.disabled = false;
                    exportBtn.disabled = true;
                    statsContainer.style.display = 'none';
                    showNotification(`‚úÖ ƒê√£ t·∫°o ${data.count} email`, 'success');
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                showNotification(`‚ùå L·ªói: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'üé≤ T·∫°o Email';
            }
        });

        // Check emails
        checkBtn.addEventListener('click', async () => {
            if (generatedEmails.length === 0) {
                alert('Vui l√≤ng t·∫°o email tr∆∞·ªõc');
                return;
            }

            checkBtn.disabled = true;
            checkBtn.textContent = '‚è≥ ƒêang ki·ªÉm tra...';
            progressContainer.style.display = 'block';
            checkResults = [];

            try {
                const response = await fetch('/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emails: generatedEmails })
                });

                const data = await response.json();

                if (data.success) {
                    // Start polling for progress
                    startProgressPolling();
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                showNotification(`‚ùå L·ªói: ${error.message}`, 'error');
                checkBtn.disabled = false;
                checkBtn.textContent = '‚úÖ Ki·ªÉm Tra';
                progressContainer.style.display = 'none';
            }
        });

        // Start polling for progress
        function startProgressPolling() {
            checkingInterval = setInterval(async () => {
                try {
                    const response = await fetch('/progress');
                    const data = await response.json();

                    updateProgress(data);

                    if (!data.is_running) {
                        stopProgressPolling();
                        
                        if (data.status === 'completed') {
                            checkResults = data.results;
                            displayResults(checkResults);
                            updateCharts(checkResults);
                            exportBtn.disabled = false;
                            showNotification('‚úÖ Ki·ªÉm tra ho√†n t·∫•t!', 'success');
                        } else if (data.status.startsWith('error')) {
                            showNotification(`‚ùå L·ªói: ${data.status}`, 'error');
                        }

                        checkBtn.disabled = false;
                        checkBtn.textContent = '‚úÖ Ki·ªÉm Tra';
                    }
                } catch (error) {
                    console.error('Progress polling error:', error);
                }
            }, 1000);
        }

        // Stop progress polling
        function stopProgressPolling() {
            if (checkingInterval) {
                clearInterval(checkingInterval);
                checkingInterval = null;
            }
        }

        // Update progress bar
        function updateProgress(data) {
            const percent = data.total > 0 ? (data.current / data.total * 100) : 0;
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `ƒêang x·ª≠ l√Ω: ${data.current} / ${data.total}`;

            // Update partial results
            if (data.results && data.results.length > 0) {
                displayResults(data.results);
            }
        }

        // Display generated emails
        function displayEmails(emails) {
            resultsBody.innerHTML = '';
            emails.forEach((email, index) => {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${email}</td>
                        <td><span class="badge badge-pending">Ch·ªù ki·ªÉm tra</span></td>
                        <td><span class="badge badge-pending">Ch·ªù ki·ªÉm tra</span></td>
                        <td><span class="badge badge-pending">Ch·ªù ki·ªÉm tra</span></td>
                        <td>-</td>
                    </tr>
                `;
                resultsBody.innerHTML += row;
            });
            updateResultsInfo(emails.length, 0);
        }

        // Display results
        function displayResults(results) {
            resultsBody.innerHTML = '';
            results.forEach((result, index) => {
                const smtpBadge = getStatusBadge(result.smtp_status);
                const fbBadge = result.has_facebook ? 
                    '<span class="badge badge-yes">‚úì Yes</span>' : 
                    '<span class="badge badge-no">‚úó No</span>';
                const scoreBadge = getScoreBadge(result.score);

                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td class="email-cell" title="${result.email}">${result.email}</td>
                        <td>${smtpBadge}</td>
                        <td>${fbBadge}</td>
                        <td>${result.country}</td>
                        <td>${scoreBadge}</td>
                    </tr>
                `;
                resultsBody.innerHTML += row;
            });
            updateResultsInfo(results.length, results.length);
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            const badges = {
                'LIVE': '<span class="badge badge-live">‚úì LIVE</span>',
                'DIE': '<span class="badge badge-die">‚úó DIE</span>',
                'UNKNOWN': '<span class="badge badge-unknown">? UNKNOWN</span>'
            };
            return badges[status] || '<span class="badge badge-pending">-</span>';
        }

        // Get score badge HTML
        function getScoreBadge(score) {
            const value = (score * 100).toFixed(0);
            let className = 'badge-low';
            if (score >= 0.7) className = 'badge-high';
            else if (score >= 0.4) className = 'badge-medium';
            
            return `<span class="badge ${className}">${value}%</span>`;
        }

        // Update results info
        function updateResultsInfo(total, checked) {
            resultsInfo.innerHTML = `
                <p>T·ªïng s·ªë email: <strong>${total}</strong> | ƒê√£ ki·ªÉm tra: <strong>${checked}</strong></p>
            `;
        }

        // Update charts
        function updateCharts(results) {
            statsContainer.style.display = 'flex';

            // SMTP Chart
            const smtpData = {
                live: results.filter(r => r.smtp_status === 'LIVE').length,
                die: results.filter(r => r.smtp_status === 'DIE').length,
                unknown: results.filter(r => r.smtp_status === 'UNKNOWN').length
            };

            updateOrCreateChart('smtpChart', 'smtp', 'SMTP Status', 
                ['LIVE', 'DIE', 'UNKNOWN'],
                [smtpData.live, smtpData.die, smtpData.unknown],
                ['#4CAF50', '#f44336', '#FF9800']
            );

            // Facebook Chart
            const fbData = {
                yes: results.filter(r => r.has_facebook).length,
                no: results.filter(r => !r.has_facebook).length
            };

            updateOrCreateChart('facebookChart', 'facebook', 'Facebook Account',
                ['C√≥ Facebook', 'Kh√¥ng c√≥'],
                [fbData.yes, fbData.no],
                ['#2196F3', '#9E9E9E']
            );

            // Country Chart
            const countries = {};
            results.forEach(r => {
                countries[r.country] = (countries[r.country] || 0) + 1;
            });
            
            const topCountries = Object.entries(countries)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            updateOrCreateChart('countryChart', 'country', 'Top 5 Qu·ªëc Gia',
                topCountries.map(c => c[0]),
                topCountries.map(c => c[1]),
                ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
            );
        }

        // Create or update chart
        function updateOrCreateChart(canvasId, chartKey, title, labels, data, colors) {
            const ctx = document.getElementById(canvasId);
            
            if (charts[chartKey]) {
                charts[chartKey].data.labels = labels;
                charts[chartKey].data.datasets[0].data = data;
                charts[chartKey].update();
            } else {
                charts[chartKey] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#333', font: { size: 12 } }
                            },
                            title: {
                                display: true,
                                text: title,
                                color: '#333',
                                font: { size: 16, weight: 'bold' }
                            }
                        }
                    }
                });
            }
        }

        // Export to CSV
        exportBtn.addEventListener('click', async () => {
            if (checkResults.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t');
                return;
            }

            exportBtn.disabled = true;
            exportBtn.textContent = '‚è≥ ƒêang xu·∫•t...';

            try {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const filename = `email_check_${timestamp}.csv`;

                const response = await fetch('/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ results: checkResults, filename })
                });

                const data = await response.json();

                if (data.success) {
                    // Trigger download
                    window.location.href = `/download/${data.filename}`;
                    showNotification(`‚úÖ ƒê√£ xu·∫•t file: ${data.filename}`, 'success');
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                showNotification(`‚ùå L·ªói: ${error.message}`, 'error');
            } finally {
                exportBtn.disabled = false;
                exportBtn.textContent = 'üíæ Xu·∫•t CSV';
            }
        });

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Email Checker loaded successfully');
        });
    </script>
</body>
</html>
