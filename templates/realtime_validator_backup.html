<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Email Validator - Realtime</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .input-section {
            margin-bottom: 20px;
        }

        .input-section label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .input-section textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        .input-section textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .options-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .option-group {
            flex: 1;
            min-width: 200px;
        }

        .option-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .option-group input, .option-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            padding: 15px 40px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card.live {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .stat-card.die {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        .stat-card.unknown {
            background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
        }

        .stat-card h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .percentage {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .progress-section {
            margin-bottom: 20px;
        }

        .progress-bar-container {
            background: #f0f0f0;
            height: 40px;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: 0.9em;
        }

        .results-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .results-section {
                grid-template-columns: 1fr;
            }
        }

        .result-panel {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
        }

        .result-panel-header {
            padding: 15px;
            font-weight: bold;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-panel-header.live {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .result-panel-header.die {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        .result-panel-body {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .result-table {
            width: 100%;
            font-size: 0.85em;
        }

        .result-table th {
            background: #e9ecef;
            padding: 10px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .result-table td {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
        }

        .result-table tr:hover {
            background: #f1f3f5;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .status-badge.live {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.die {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.catch-all {
            background: #fff3cd;
            color: #856404;
        }

        .log-console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #667eea;
            padding-left: 10px;
        }

        .log-entry.success {
            border-left-color: #38ef7d;
        }

        .log-entry.error {
            border-left-color: #f45c43;
        }

        .log-entry .timestamp {
            color: #888;
            margin-right: 10px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-export {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-export:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-export i {
            margin-right: 5px;
        }

        #connectionStatus {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #connectionStatus.connected {
            background: #d4edda;
            color: #155724;
        }

        #connectionStatus.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .pulse {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div id="connectionStatus" class="disconnected">
        <div class="pulse"></div>
        <span id="connectionText">ƒêang k·∫øt n·ªëi...</span>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-shield-check"></i> Professional Email Validator</h1>
            <p>ƒê·ªô ch√≠nh x√°c 95-99% ‚Ä¢ Realtime Updates ‚Ä¢ Multi-Layer Validation</p>
        </div>

        <!-- Main Panel -->
        <div class="main-panel">
            <!-- Input Section -->
            <div class="input-section">
                <label><i class="fas fa-envelope"></i> Danh s√°ch Email (M·ªói d√≤ng 1 email ho·∫∑c ngƒÉn c√°ch b·ªüi d·∫•u ph·∫©y)</label>
                <textarea id="emailInput" placeholder="example1@gmail.com&#10;example2@yahoo.com&#10;example3@outlook.com"></textarea>
            </div>

            <!-- Options -->
            <div class="options-row">
                <div class="option-group">
                    <label><i class="fas fa-users"></i> S·ªë Workers (Song song)</label>
                    <input type="number" id="maxWorkers" value="20" min="1" max="50">
                </div>
                <div class="option-group">
                    <label><i class="fas fa-redo"></i> S·ªë l·∫ßn retry</label>
                    <input type="number" id="maxRetries" value="3" min="0" max="5">
                </div>
            </div>

            <!-- Start Button -->
            <button id="startBtn" class="btn btn-primary" onclick="startValidation()">
                <i class="fas fa-play"></i> B·∫Øt ƒë·∫ßu ki·ªÉm tra
            </button>
        </div>

        <!-- Statistics -->
        <div class="main-panel" id="statsPanel" style="display: none;">
            <h2 style="margin-bottom: 20px;"><i class="fas fa-chart-bar"></i> Th·ªëng k√™ Realtime</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>T·ªïng Email</h3>
                    <div class="number" id="statTotal">0</div>
                </div>
                <div class="stat-card live">
                    <h3><i class="fas fa-check-circle"></i> LIVE</h3>
                    <div class="number" id="statLive">0</div>
                    <div class="percentage" id="statLivePercent">0%</div>
                </div>
                <div class="stat-card die">
                    <h3><i class="fas fa-times-circle"></i> DIE</h3>
                    <div class="number" id="statDie">0</div>
                    <div class="percentage" id="statDiePercent">0%</div>
                </div>
                <div class="stat-card unknown">
                    <h3><i class="fas fa-question-circle"></i> UNKNOWN</h3>
                    <div class="number" id="statUnknown">0</div>
                    <div class="percentage" id="statUnknownPercent">0%</div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-section">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%;">
                        <span id="progressText">0%</span>
                    </div>
                </div>
                <div class="progress-info">
                    <span id="progressStatus">ƒêang x·ª≠ l√Ω...</span>
                    <span id="progressCount">0 / 0</span>
                </div>
            </div>

            <!-- Export Buttons -->
            <div class="export-buttons">
                <button class="btn-export" onclick="exportResults('live', 'txt')">
                    <i class="fas fa-download"></i> Export LIVE (.txt)
                </button>
                <button class="btn-export" onclick="exportResults('die', 'txt')">
                    <i class="fas fa-download"></i> Export DIE (.txt)
                </button>
                <button class="btn-export" onclick="exportResults('full', 'csv')">
                    <i class="fas fa-file-csv"></i> Export FULL (.csv)
                </button>
                <button class="btn-export" onclick="exportResults('errors', 'json')">
                    <i class="fas fa-file-code"></i> Export ERRORS (.json)
                </button>
            </div>
        </div>

        <!-- Results Tables -->
        <div class="results-section" id="resultsSection" style="display: none;">
            <!-- LIVE Results -->
            <div class="result-panel">
                <div class="result-panel-header live">
                    <span><i class="fas fa-check-circle"></i> LIVE Emails</span>
                    <span id="liveCount">0</span>
                </div>
                <div class="result-panel-body">
                    <table class="result-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Response Time</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody id="liveTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- DIE Results -->
            <div class="result-panel">
                <div class="result-panel-header die">
                    <span><i class="fas fa-times-circle"></i> DIE Emails</span>
                    <span id="dieCount">0</span>
                </div>
                <div class="result-panel-body">
                    <table class="result-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Response Time</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody id="dieTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Log Console -->
        <div class="main-panel" id="logPanel" style="display: none;">
            <h2 style="margin-bottom: 15px;"><i class="fas fa-terminal"></i> Console Log (Realtime)</h2>
            <div class="log-console" id="logConsole">
                <div class="log-entry">
                    <span class="timestamp">[--:--:--]</span>
                    <span>S·∫µn s√†ng ƒë·ªÉ b·∫Øt ƒë·∫ßu ki·ªÉm tra...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO
        const socket = io();
        let currentSessionId = null;
        let validationInProgress = false;

        // Connection handlers
        socket.on('connect', () => {
            console.log('Connected to server');
            document.getElementById('connectionStatus').className = 'connected';
            document.getElementById('connectionText').textContent = 'ƒê√£ k·∫øt n·ªëi';
            addLog('‚úì ƒê√£ k·∫øt n·ªëi v·ªõi server', 'success');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            document.getElementById('connectionStatus').className = 'disconnected';
            document.getElementById('connectionText').textContent = 'M·∫•t k·∫øt n·ªëi';
            addLog('‚úó M·∫•t k·∫øt n·ªëi v·ªõi server', 'error');
        });

        // Start validation
        function startValidation() {
            const emailText = document.getElementById('emailInput').value.trim();
            if (!emailText) {
                alert('Vui l√≤ng nh·∫≠p danh s√°ch email!');
                return;
            }

            // Parse emails
            const emails = emailText.split(/[\n,]/)
                .map(e => e.trim())
                .filter(e => e.length > 0);

            if (emails.length === 0) {
                alert('Kh√¥ng t√¨m th·∫•y email h·ª£p l·ªá!');
                return;
            }

            // Generate session ID
            currentSessionId = 'session_' + Date.now();

            // Disable button
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
            validationInProgress = true;

            // Show panels
            document.getElementById('statsPanel').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'grid';
            document.getElementById('logPanel').style.display = 'block';

            // Clear previous results
            document.getElementById('liveTableBody').innerHTML = '';
            document.getElementById('dieTableBody').innerHTML = '';
            document.getElementById('logConsole').innerHTML = '';

            // Reset stats
            updateStats({
                total: emails.length,
                processed: 0,
                live: 0,
                die: 0,
                unknown: 0,
                catch_all: 0,
                disposable: 0
            });

            addLog(`üöÄ B·∫Øt ƒë·∫ßu ki·ªÉm tra ${emails.length} emails...`, 'success');

            // Start validation via WebSocket
            socket.emit('start_validation', {
                session_id: currentSessionId,
                emails: emails,
                options: {
                    max_workers: parseInt(document.getElementById('maxWorkers').value),
                    max_retries: parseInt(document.getElementById('maxRetries').value)
                }
            });
        }

        // Progress updates
        socket.on('validation_progress', (data) => {
            if (data.session_id !== currentSessionId) return;

            updateStats(data.stats);
            updateProgress(data.progress, data.stats.processed, data.stats.total);

            if (data.current_email) {
                document.getElementById('progressStatus').textContent = 
                    `ƒêang ki·ªÉm tra: ${data.current_email}`;
            }
        });

        // Individual result
        socket.on('validation_result', (data) => {
            if (data.session_id !== currentSessionId) return;

            // You can add individual results to tables here if needed
        });

        // Log messages
        socket.on('validation_log', (data) => {
            if (data.session_id !== currentSessionId) return;
            
            const status = data.message.includes('LIVE') ? 'success' :
                          data.message.includes('DIE') ? 'error' : '';
            addLog(data.message, status);
        });

        // Completion
        socket.on('validation_complete', (data) => {
            if (data.session_id !== currentSessionId) return;

            validationInProgress = false;
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-play"></i> B·∫Øt ƒë·∫ßu ki·ªÉm tra';

            addLog('‚úì Ho√†n th√†nh ki·ªÉm tra!', 'success');
            
            // Load full results
            loadSessionResults(currentSessionId);
        });

        // Error handling
        socket.on('validation_error', (data) => {
            validationInProgress = false;
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-play"></i> B·∫Øt ƒë·∫ßu ki·ªÉm tra';

            addLog(`‚úó L·ªói: ${data.message}`, 'error');
            alert('L·ªói: ' + data.message);
        });

        // Update statistics
        function updateStats(stats) {
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statLive').textContent = stats.live;
            document.getElementById('statDie').textContent = stats.die;
            document.getElementById('statUnknown').textContent = stats.unknown;

            const livePercent = stats.total > 0 ? (stats.live / stats.total * 100).toFixed(1) : 0;
            const diePercent = stats.total > 0 ? (stats.die / stats.total * 100).toFixed(1) : 0;
            const unknownPercent = stats.total > 0 ? (stats.unknown / stats.total * 100).toFixed(1) : 0;

            document.getElementById('statLivePercent').textContent = livePercent + '%';
            document.getElementById('statDiePercent').textContent = diePercent + '%';
            document.getElementById('statUnknownPercent').textContent = unknownPercent + '%';

            document.getElementById('liveCount').textContent = stats.live;
            document.getElementById('dieCount').textContent = stats.die;
        }

        // Update progress
        function updateProgress(percentage, processed, total) {
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = percentage.toFixed(1) + '%';
            document.getElementById('progressCount').textContent = `${processed} / ${total}`;
        }

        // Add log entry
        function addLog(message, type = '') {
            const logConsole = document.getElementById('logConsole');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry ' + type;
            
            const now = new Date();
            const timestamp = now.toTimeString().split(' ')[0];
            
            logEntry.innerHTML = `
                <span class="timestamp">[${timestamp}]</span>
                <span>${message}</span>
            `;
            
            logConsole.appendChild(logEntry);
            logConsole.scrollTop = logConsole.scrollHeight;
        }

        // Load session results
        async function loadSessionResults(sessionId) {
            try {
                const response = await fetch(`/api/validate/session/${sessionId}`);
                const data = await response.json();

                if (data.success) {
                    const results = data.session.results;
                    
                    // Populate LIVE table
                    const liveTableBody = document.getElementById('liveTableBody');
                    liveTableBody.innerHTML = '';
                    if (results.live) {
                        results.live.forEach(result => {
                            const row = liveTableBody.insertRow();
                            row.innerHTML = `
                                <td>${result.email}</td>
                                <td>${result.response_time}s</td>
                                <td><span class="status-badge ${result.status.toLowerCase()}">${result.score.toFixed(1)}</span></td>
                            `;
                        });
                    }

                    // Populate DIE table
                    const dieTableBody = document.getElementById('dieTableBody');
                    dieTableBody.innerHTML = '';
                    if (results.die) {
                        results.die.forEach(result => {
                            const row = dieTableBody.insertRow();
                            row.innerHTML = `
                                <td>${result.email}</td>
                                <td>${result.response_time}s</td>
                                <td>${result.reason || 'N/A'}</td>
                            `;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading results:', error);
                addLog('‚úó L·ªói khi t·∫£i k·∫øt qu·∫£: ' + error.message, 'error');
            }
        }

        // Export results
        function exportResults(type, format) {
            if (!currentSessionId) {
                alert('Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ export!');
                return;
            }

            const url = `/api/export/${currentSessionId}/${type}?format=${format}`;
            window.open(url, '_blank');
            addLog(`üì• ƒêang export ${type.toUpperCase()} (${format})...`, 'success');
        }
    </script>
</body>
</html>
